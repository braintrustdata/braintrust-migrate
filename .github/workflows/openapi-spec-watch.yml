name: OpenAPI Spec Watch

on:
  schedule:
    - cron: "0 15 * * 4"
  workflow_dispatch:

jobs:
  openapi-watch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --locked --group scripts

      - name: Check OpenAPI spec
        id: check
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: uv run python scripts/openapi_weekly_check.py --write-updated --output "$GITHUB_OUTPUT"

      - name: Post to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SUMMARY: ${{ steps.check.outputs.summary }}
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          import urllib.request

          webhook = os.environ.get("SLACK_WEBHOOK_URL")
          summary = (os.environ.get("SUMMARY") or "").strip()

          if not webhook:
            print("SLACK_WEBHOOK_URL not set; skipping.")
            sys.exit(0)

          if not summary:
            summary = "OpenAPI weekly check ran, but no summary was produced."

          payload = {"text": summary}
          data = json.dumps(payload).encode()
          req = urllib.request.Request(
            webhook,
            data=data,
            headers={"Content-Type": "application/json"},
          )
          with urllib.request.urlopen(req, timeout=20) as resp:
            print(resp.read().decode())
          PY
      - name: Commit updated spec to main
        if: steps.check.outputs.changed == 'true'
        run: |
          git add openapi_spec.json
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "Update OpenAPI spec" || exit 0
          git push origin HEAD:main
